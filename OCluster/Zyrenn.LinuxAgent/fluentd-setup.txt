Fluentd Log Collection & Enrichment Guide
Overview
This guide explains how to collect logs from hosts using Fluentd, parse them correctly, enrich log records with extra metadata (host IP, client_id, UTC timestamp), and forward the logs for further processing or storage.

Step 1: Install Fluentd
Install Fluentd on your host or container. On Linux, you can use official packages:

bash
Copy
Edit
sudo apt-get install -y td-agent
Or use Docker:

bash
Copy
Edit
docker run -it -v /var/log:/var/log fluent/fluentd
Step 2: Ensure Fluentd has Read Access to Logs
System logs like /var/log/syslog are often only readable by root or adm group.

Add the Fluentd user (usually td-agent) to the adm group:

bash
Copy
Edit
sudo usermod -aG adm td-agent
sudo systemctl restart td-agent
Step 3: Configure Fluentd Input Source
Create or modify the Fluentd config file (usually /etc/td-agent/td-agent.conf) with a tail input plugin:

conf
Copy
Edit
<source>
  @type tail
  path /var/log/syslog
  pos_file /var/log/td-agent/syslog.pos
  tag host.syslog
  format /^(?<time>[^ ]+) (?<message>.*)$/
  time_format %Y-%m-%dT%H:%M:%S.%N%z
</source>
This regex extracts the timestamp (time) and the rest as the message.

Adjust the regex based on your actual log format.

pos_file helps Fluentd remember the last read position.

Step 4: Enrich Logs with Extra Metadata
Use Fluentd's record_transformer filter to add fields such as host IP, client_id, and UTC timestamp.

conf
Copy
Edit
<filter host.syslog>
  @type record_transformer
  enable_ruby true

  <record>
    hostname ${Socket.gethostname}
    host_ip ${`hostname -I`.strip.split(' ').first}
    client_id YOUR_CLIENT_ID_HERE
    timestamp ${Time.now.utc.iso8601}
  </record>
</filter>
hostname — machine hostname

host_ip — first IP address from hostname -I

client_id — replace with your unique client identifier

timestamp — current UTC time in ISO8601 format

Step 5: Output / Forward Logs
Configure output plugins to forward logs to your backend:

conf
Copy
Edit
<match host.syslog>
  @type forward
  <server>
    host your-log-collector-host
    port 24224
  </server>
</match>
Or save locally to a file:

conf
Copy
Edit
<match host.syslog>
  @type file
  path /var/log/td-agent/processed_syslog.log
  append true
</match>
Step 6: Restart Fluentd to Apply Configuration
bash
Copy
Edit
sudo systemctl restart td-agent
Or restart your Docker container.